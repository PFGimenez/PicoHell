pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- pico hell (jupiter hell demake)
-- by cpiod

-- state:
-- 0: player turn
-- 1: player aim
-- 2: enemy turn
-- 100: title screen
-- 101: game over screen

-- flag: 0:non-walkable
-- 1:bullet-opaque

function _init()
	x=8
	y=8
	facing=1
	cam_x=0
	cam_y=0
	state=100
 bullet_anim=false
 bullets={}
end



-->8
-- draw

function _draw()
 if(state<100) _draw_game()
 if(state==100) _draw_title()
end

function _draw_title()
cls()
?"pico hell"
?"wow"
end

function _draw_game()
 cls()
 camera(cam_x+8*x-64,cam_y+8*y-64)
 -- todo: background art?
 map(0,0,0,0)
 -- player
 spr(16,x*8,y*8,1,1,facing>0)
 -- aim
 if state==1 then
  local s=17
  -- aim on player
  if(a_x==x and a_y==y) s=18
  -- no los
  -- todo: compute at aim change
  if(los_line(a_x,a_y,x,y,nil_fun,chk_opaque)) s=19
  spr(s,a_x*8,a_y*8)
 end
-- los_line(x,y,1,1,los_test,chk_wall)
 
 if(bullet_anim) draw_bullets()
 
 flip()
end

function draw_bullets()
 for b in all(bullets) do
  pset(b.x0,b.y0)
  b.x0+=b.vx
  b.y0+=b.vy
  b.dur-=1
  if(b.dur==0) del(bullets,b)
 end
 if(#bullets==0) bullet_anim=false
end

function los_test(x,y)
-- if fget(mget(x,y))%2==1 then
  spr(2,x*8,y*8)
-- end
end

-->8
-- entity

-- weapons:
-- 0: pistol
-- 1: shotgun
-- 2: rifle
function make_weapon(typ)
	if(typ==0) return {mag=6,bul=1,rng=5,dmg=4,disp=1}
	return nil
end

function make_enemy(typ)
 if(typ==0) return {hp=10,wpn=make_weapon(0)}
end
-->8
-- gameloop

dep={{-1,0},{1,0},nil,{0,-1},
nil,nil,nil,{0,1}}

function _update()
 if state==100 then
  if(btn()!=0) state=0
 end

 if(bullet_anim) return

 -- player turn
 if state==0 then
  local d=dep[btn()]
  -- move
  if d!=nil then
   local next_x=x+d[1]
   local next_y=y+d[2]
   if fget(mget(next_x,next_y))%2==0 then
    x=next_x
    y=next_y
    state=2
    if(d[1]!=0) facing=d[1]
    local cam_xc=d[1]*20
    local cam_yc=d[2]*20
    if(cam_x<cam_xc) cam_x+=4
    if(cam_x>cam_xc) cam_x-=4
    if(cam_y<cam_yc) cam_y+=4
    if(cam_y>cam_yc) cam_y-=4
   end
  -- shoot
  elseif btn(5) then
   state=1
   -- todo: aim an enemy
   a_x=x
   a_y=y
  -- action button
  elseif btn(4) then
  
  end
  
 -- player aim
 elseif state==1 then
  local d=dep[band(btn(),15)]
  -- aim
  if d!=nil then
   a_x+=d[1]
   a_y+=d[2]
  end
  if not btn(5) then
   -- no self-shot
   if a_x==x and a_y==y then
    sfx(1)
    state=0
   else 
	   bullet_anim=true
	   local vx=(a_x-x)
	   local vy=(a_y-y)
	   add(bullets,{x0=8*x+4,y0=8*y+4,vx=vx,vy=vy,dur=10})
	   state=2
	   sfx(0)
   end
  end
  
 -- enemy turn  
 elseif state==2 then
  for i=1,5 do
   flip() -- placeholder
  end
  state=0
 end
end
-->8
-- los

function nil_fun() end

function chk_wall(x,y)
 return band(fget(mget(x,y)),1)!=0
end

function chk_opaque(x,y)
 return band(fget(mget(x,y)),2)!=0
end

function los_line(x1, y1, x2, y2, fun, chk)
  delta_x = x2 - x1
  ix = delta_x > 0 and 1 or -1
  delta_x = 2 * abs(delta_x)
 
  delta_y = y2 - y1
  iy = delta_y > 0 and 1 or -1
  delta_y = 2 * abs(delta_y)
 
  if(chk(x1,y1)) return true
  fun(x1, y1)
 
  if delta_x >= delta_y then
    error = delta_y - delta_x / 2
 
    while x1 != x2 do
      if (error > 0) or ((error == 0) and (ix > 0)) then
        error = error - delta_x
        y1 = y1 + iy
      end
 
      error = error + delta_y
      x1 = x1 + ix
 
						if(chk(x1,y1)) return true
      fun(x1, y1)
    end
  else
    error = delta_x - delta_y / 2
 
    while y1 != y2 do
      if (error > 0) or ((error == 0) and (iy > 0)) then
        error = error - delta_y
        x1 = x1 + ix
      end
 
      error = error + delta_x
      y1 = y1 + iy
      if(chk(x1,y1)) return true
      fun(x1, y1)
    end
  end
  return false
end


__gfx__
00000000777777210000000000000000009988000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000776666d20cc000000000000009a988800000000005555500055555000000000090000000000000000000000000000000000000000000000000000000
00700700766667d20c0000000dddddd009aa98200000000005000555550005000000000090000000000000000000000000000000000000000000000000000000
00077000766766d100000cc00d0dd00009aa98200000000005000000000005000000000000000000000000000000000000000000000000000000000000000000
00077000767666d100000c000000000009aa98200000000005000000000005059999999090000000000000000000000000000000000000000000000000000000
00700700766666d100cc00000000000009aa98200000000005500000000055059009009090000000000000000000000000000000000000000000000000000000
000000002dddddd100c0000000ddd0dd009998000000000000500000000050059009009090000000000000000000000000000000000000000000000000000000
00000000122111110000000000000dd0000000000000000000500000000050059009009090000000000000000000000000000000000000000000000000000000
00333300000000000000000000000000000000000000000000500000000050050000000000000000000000000000000000000000000000000000000000000000
00414100003330000055500000888000000000000000000005500000000055050000000900000000000000000000000000000000000000000000000000000000
00111100030003000500050008000800000000000000000005000000000005050000000900000000000000000000000000000000000000000000000000000000
00111000030303000505050008080800000000000000000005000000000005050000000000000000000000000000000000000000000000000000000000000000
08888800030003000500050008000800000000000000000005000555550005050000000900000000000000000000000000000000000000000000000000000000
00811800003330000055500000888000000000000000000005555500055555050000000900000000000000000000000000000000000000000000000000000000
00111000000000000000000000000000000000000000000000000000000000050000000900000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000055555555555555550000000900000000000000000000000000000000000000000000000000000000
__gff__
0003000003000000010100000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0106070607060706070607060706070607060706070607000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0116171617161716171617161716171617161716171617000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0106070607060706070607060706070607060706070607000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0116171617161716171617161716171617161716171617000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0106070607060706070607060706070607060706070607000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0116171617161716171601161716171617161716171617000001010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100040000040000000001000008080800000000000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000009001800000004000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000009001800000000000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000010101000008080800000000000000000101010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000400000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000004000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000400000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000040000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000101000000000000000000000000000001010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000000000000000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000000000000000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000000000000000000000000010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000010101000000000000000000000000000101010000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000f05016050190501e0502305027050290502a0502a0502705026050210500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000200000205003050030500c0500c0500b0500a0500a050070500305002050010500005000050050000400003000020000200000000000000000000000000000000000000000000000000000000000000000000
